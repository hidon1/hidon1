
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיפוש בתנ"ך</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&family=Noto+Serif+Hebrew:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --gradient-accent: linear-gradient(135deg, #c09b3b 0%, #d4af37 100%);
            --background-light: #fdfcf9;
            --text-color: #212529; 
            --text-secondary: #6c757d;
            --card-background: rgba(255, 255, 255, 0.8);
            --border-color: rgba(0, 0, 0, 0.07);
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
            --box-shadow-light: 0 10px 40px rgba(0, 0, 0, 0.06);
            --base-font-size: 1.1em;
            --results-font-size-multiplier: 1;
            --reader-font-size-multiplier: 1;
        }

        body {
            --modal-background: #FFFFFF;
        }

        body.dark-mode {
            --gradient-primary: linear-gradient(135deg, #3a7bd5 0%, #3a6073 100%);
            --background-light: #12181F;
            --text-color: #e9ecef; 
            --text-secondary: #adb5bd;
            --card-background: rgba(26, 43, 60, 0.75);
            --border-color: rgba(255, 255, 255, 0.1);
            --modal-background: #1A2B3C;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--background-light);
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.03"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z"/%3E%3Cpath d="M6 5V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h4V0h1v5h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h5v1h-5v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4h-1v-4h-4v4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4v-4H0v-1h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0h1v4h4V0z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
            color: var(--text-color); margin: 0; padding: 40px 20px; direction: rtl; text-align: right; line-height: 1.8; transition: background-color 0.3s ease;
        }
        
        .container {
            max-width: 900px; margin: 0 auto; background: var(--card-background); padding: 50px; border-radius: var(--border-radius-lg); box-shadow: var(--box-shadow-light); position: relative; z-index: 1; border: 1px solid var(--border-color); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        
        header { text-align: center; margin-bottom: 50px; }
        .logo-container { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .logo-icon { width: 60px; height: 60px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); animation: float 3s ease-in-out infinite; }
        .logo-icon::before { content: "📜"; font-size: 2em; }
        .logo-icon::after { content: ""; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: var(--gradient-accent); opacity: 0; animation: pulse-ring 2s infinite; }
        
        header h1 {
            font-family: 'Noto Serif Hebrew', serif;
            font-size: 3.5em; font-weight: 700; margin: 0; letter-spacing: -1px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        header p { color: var(--text-secondary); font-size: 1.3em; max-width: 700px; margin: 15px auto 0; font-weight: 400; }

        .search-area { margin-bottom: 40px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .input-group { display: flex; width: 100%; max-width: 600px; position: relative; }
        
        .input-group .search-icon { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); color: var(--text-secondary); font-size: 1.1em; z-index: 2; }
        .input-group input[type="text"] {
            flex-grow: 1; padding: 18px 55px 18px 25px; font-size: 1.2em; font-family: 'Heebo', sans-serif; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); transition: all 0.3s ease; background: rgba(255,255,255,0.6); color: var(--text-color);
        }
        body.dark-mode .input-group input[type="text"]{ background: rgba(0,0,0,0.2); }
        .input-group input[type="text"]:focus { outline: none; border-color: #c09b3b; box-shadow: 0 0 0 4px rgba(192, 155, 59, 0.2); }

        .action-button { padding: 18px 35px; font-size: 1.2em; font-weight: 600; font-family: 'Heebo', sans-serif; color: #fff; border: none; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.3s ease; white-space: nowrap; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); }
        .action-button.primary { background: var(--gradient-primary); }
        .action-button:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        
        #hamburgerMenuBtn { padding: 18px 25px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; }

        #menuDropdown { display: block; position: fixed; top: 0; left: -340px; width: 320px; height: 100%; background: var(--card-background); backdrop-filter: blur(20px); box-shadow: 10px 0 35px rgba(0, 0, 0, 0.15); z-index: 1000; transition: left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); padding: 25px 0; overflow-y: auto; }
        #menuDropdown.show { left: 0; }
        
        #menuOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s; }
        #menuOverlay.show { opacity: 1; visibility: visible; }

        .menu-option { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 1.1em; transition: all 0.2s ease; font-weight: 500; }
        .menu-option:not(.font-size-control-container):hover { background: rgba(192, 155, 59, 0.1); color: var(--text-color); transform: translateX(5px); }
        .menu-option i { width: 20px; text-align: center; margin-left: 10px; }
        .menu-option.toggle-switch-container { justify-content: flex-end; gap: 10px; }
        
        .font-size-control-container { justify-content: space-between; }
        .font-size-control-container > span { font-weight: 500; }
        .font-size-control-container .controls { display: flex; align-items: center; gap: 15px; }
        .font-size-control-container .controls span { font-size: 1em; min-width: 45px; text-align: center; }
        .font-size-control-container .controls i { cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.08); transition: all 0.2s ease; margin: 0; }
        .font-size-control-container .controls i:hover { background: var(--gradient-primary); color: white; transform: scale(1.1); }

        .switch { position: relative; display: inline-block; width: 55px; height: 32px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .4s; border-radius: 34px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);}
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);}
        input:checked + .slider { background-image: var(--gradient-accent); }
        input:checked + .slider:before { transform: translateX(23px); }
        
        .menu-divider { height: 1px; background-color: var(--border-color); margin: 20px 25px; }
        .menu-header { padding: 0 25px 10px; font-weight: 700; font-size: 1.1em; color: var(--text-color); opacity: 0.8; }
        #searchHistoryList { list-style: none; padding: 0; margin: 0; }
        #searchHistoryList li { padding: 12px 25px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; }
        #searchHistoryList li:hover { background: rgba(192, 155, 59, 0.1); transform: translateX(5px); }
        #searchHistoryList li i { margin-left: 15px; color: var(--text-secondary); }

        #loading { display: none; text-align: center; font-size: 1.3em; margin-top: 20px; }
        #loading i { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        .results-header h3 { margin: 0; font-size: 1.8em; font-weight: 700; font-family: 'Noto Serif Hebrew', serif; color: var(--text-color); }
        .results-header .search-mode { font-size: 1.1em; color: var(--text-secondary); }
        
        /* === NEW: Staggered animation styles === */
        .verse-card {
            background: var(--card-background); padding: 35px; margin-bottom: 25px;
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow-light);
            cursor: pointer; transition: all 0.3s ease; border-radius: var(--border-radius-lg);
            opacity: 0; transform: translateY(20px);
        }
        .verse-card.visible { opacity: 1; transform: translateY(0); }
        .verse-card:hover { transform: translateY(-5px); box-shadow: 0 20px 45px rgba(0, 0, 0, 0.1); border-color: #c09b3b; }
        
        .verse-location { font-weight: 600; font-family: 'Heebo', sans-serif; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 15px; font-size: 1.3em; }
        .verse-location .gematria-value { font-size: 0.9em; color: var(--text-secondary); }
        .verse-text { line-height: 1.9; font-family: 'Noto Serif Hebrew', serif; font-size: calc(var(--base-font-size) * var(--results-font-size-multiplier)); transition: font-size 0.2s ease; }
        
        .modal-book-text { font-family: 'Noto Serif Hebrew', serif; font-size: calc(var(--base-font-size) * var(--reader-font-size-multiplier)); line-height: 1.9; transition: font-size 0.2s ease; }

        .highlight, .gematria-word { font-weight: 600; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; padding: 2px 4px; border-radius: 6px; position: relative; }
        .highlight::before, .gematria-word::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(192, 155, 59, 0.15); border-radius: 6px; z-index: -1; }
        
        .modal { display: none; position: fixed; z-index: 2001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
        .modal-content { background: var(--modal-background); backdrop-filter: blur(20px); margin: auto; padding: 40px; padding-left: 20px; border-radius: var(--border-radius-lg); width: 90%; max-width: 800px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-book-title { font-family: 'Noto Serif Hebrew', serif; font-size: 2.5em; margin-bottom: 20px; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .close-button { color: #aaa; float: left; font-size: 38px; font-weight: bold; cursor: pointer; transition: color 0.3s ease; }

        .sidebar { height: 100%; width: 0; position: fixed; z-index: 2000; top: 0; left: 0; background-color: var(--card-background); backdrop-filter: blur(20px); box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2); transition: 0.5s; overflow-x: hidden; text-align: right; box-sizing: border-box; }
        .sidebar.open { width: 350px; padding: 20px; }
        .sidebar .sidebar-content { padding: 20px; }
        .closebtn { position: absolute; top: 15px; right: 20px; font-size: 36px; cursor: pointer; }
        .sidebar-header h2 { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-align:center; padding-bottom:10px; border-bottom: 2px solid var(--border-color); }
        .reset-filter-button { background: var(--gradient-accent); border:none; width: 100%; margin-top: 20px; }

        #bookList { list-style-type: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-book-item { display: block; background: rgba(255, 255, 255, 0.2); border: 1px solid var(--border-color); color: var(--text-color); padding: 15px 20px; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.3s ease; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        body.dark-mode .sidebar-book-item { background: rgba(0,0,0,0.2); }
        .sidebar-book-item label { display: flex; align-items: center; justify-content: space-between; width:100%; cursor: pointer; }
        .sidebar-book-item input[type="checkbox"] { display: none; }
        .sidebar-book-item .checkmark { width: 22px; height: 22px; border: 2px solid #aaa; border-radius: 5px; display: inline-block; position: relative; transition: all 0.2s ease; }
        .sidebar-book-item input:checked + .checkmark { background-image: var(--gradient-primary); border-color: transparent; }
        .sidebar-book-item input:checked + .checkmark:after { content: '✔'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        .sidebar-book-item:hover { transform: translateX(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: rgba(102, 126, 234, 0.1); }

        #readBookList { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; list-style-type: none; padding: 0; margin: 0; }
        .read-book-item { background: var(--card-background); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); font-weight: 600; }
        .read-book-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); background: var(--gradient-primary); color: #fff; border-color: transparent; }

        .reader-focus-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-light); padding: 40px; box-sizing: border-box; overflow-y: auto; z-index: 3000; }
        .focus-mode-close-btn { position: fixed; top: 20px; left: 20px; font-size: 3em; cursor: pointer; color: var(--text-color); }
        
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: transparent; }
        .modal-content::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        body.dark-mode .modal-content::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); }

        @media (max-width: 768px) {
            body { padding: 15px 10px; }
            .container { padding: 30px 20px; }
            header h1 { font-size: 2.5em; }
            .input-group { flex-direction: column; align-items: stretch; }
            .action-button { width: 100%; box-sizing: border-box; }
            #hamburgerMenuBtn { position: absolute; top: 0; left: 0; }
            .input-group input[type="text"] { padding-left: 80px; }
            .modal-content { width: calc(100% - 20px); padding: 25px; padding-left: 15px; }
            #menuDropdown { width: 280px; left: -300px; }
        }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
    </style>
</head>
<body>
    
    <div id="menuOverlay"></div>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <span class="closebtn">&times;</span>
            <h2>סנן לפי ספר</h2>
        </div>
        <div class="sidebar-content">
            <ul id="bookList"></ul>
            <button id="resetFilters" class="action-button reset-filter-button">אפס סינון</button>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo-icon"></div>
            </div>
            <h1>חיפוש בתנ"ך</h1>
            <p>חקור את כתבי הקודש בעזרת כלי חיפוש מתקדם</p>
        </header>
        
        <div class="search-area">
            <div class="input-group">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" placeholder="הזן מילים לחיפוש...">
                <button id="searchButton" class="action-button primary">חפש</button>
                <button id="hamburgerMenuBtn" class="action-button primary">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <div id="loading"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        
        <div id="resultsContainer"></div>
    </div>
    
    <div id="menuDropdown">
        <div id="wholeWordToggleContainer" class="menu-option toggle-switch-container">
            <label for="wholeWordToggle">מילה שלמה</label>
            <label class="switch">
                <input type="checkbox" id="wholeWordToggle" checked>
                <span class="slider"></span>
            </label>
        </div>
        <div id="gematriaModeToggle" class="menu-option">
            <i class="fas fa-calculator"></i>&nbsp;<span id="gematriaToggleText">חיפוש גימטריה</span>
        </div>
        <div id="openBookReadModalBtn" class="menu-option">
            <i class="fas fa-book-open"></i>&nbsp;קרא ספרים
        </div>
        <div id="openSidebar" class="menu-option">
            <i class="fas fa-filter"></i>&nbsp;סנן לפי ספר
        </div>
        <div id="darkModeToggleContainer" class="menu-option toggle-switch-container">
            <label for="darkModeToggle">מצב לילה</label>
            <label class="switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
        </div>
        <div id="focusModeToggle" class="menu-option">
            <i class="fas fa-eye"></i>&nbsp;מצב ריכוז
        </div>
        <div class="menu-option font-size-control-container">
            <span>גודל גופן (תוצאות):</span>
            <div class="controls">
                <i class="fas fa-plus" id="increaseResultsFont"></i>
                <span id="resultsFontSizeValue"></span>
                <i class="fas fa-minus" id="decreaseResultsFont"></i>
            </div>
        </div>
        <div class="menu-option font-size-control-container">
            <span>גודל גופן (קריאה):</span>
            <div class="controls">
                <i class="fas fa-plus" id="increaseReaderFont"></i>
                <span id="readerFontSizeValue"></span>
                <i class="fas fa-minus" id="decreaseReaderFont"></i>
            </div>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-header">חיפושים אחרונים</div>
        <ul id="searchHistoryList"></ul>
    </div>


    <div id="fullTextModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('fullTextModal')">&times;</span><div id="modalBookTitle" class="modal-book-title"></div><div id="modalBookText" class="modal-book-text"></div></div></div>
    <div id="bookReadModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('bookReadModal')">&times;</span><h2 class="modal-book-title">קריאת ספרים</h2><ul id="readBookList"></ul></div></div>
    <div id="readerModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('readerModal')">&times;</span><div id="readerBookTitle" class="modal-book-title"></div><div id="readerBookText" class="modal-book-text"></div></div></div>
    <div id="readerFocusContainer" class="reader-focus-container"><span class="focus-mode-close-btn" onclick="exitFocusMode()">&times;</span><div id="focusModeContent" class="reader-focus-content"></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('searchInput');
            const resultsContainer = document.getElementById('resultsContainer');
            const loadingIndicator = document.getElementById('loading');
            const hamburgerMenuBtn = document.getElementById('hamburgerMenuBtn');
            const menuDropdown = document.getElementById('menuDropdown');
            const menuOverlay = document.getElementById('menuOverlay');
            const wholeWordToggle = document.getElementById('wholeWordToggle');
            const gematriaModeToggle = document.getElementById('gematriaModeToggle');
            const gematriaToggleText = document.getElementById('gematriaToggleText');
            const openSidebarBtn = document.getElementById('openSidebar');
            const sidebar = document.getElementById('sidebar');
            const openBookReadModalBtn = document.getElementById('openBookReadModalBtn');
            const bookReadModal = document.getElementById('bookReadModal');
            const readBookList = document.getElementById('readBookList');
            const fullTextModal = document.getElementById('fullTextModal');
            const modalBookTitle = document.getElementById('modalBookTitle');
            const modalBookText = document.getElementById('modalBookText');
            const readerModal = document.getElementById('readerModal');
            const readerBookTitle = document.getElementById('readerBookTitle');
            const readerBookText = document.getElementById('readerBookText');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const bookList = document.getElementById('bookList');
            const resetFiltersBtn = document.getElementById('resetFilters');
            const focusModeToggle = document.getElementById('focusModeToggle');
            const readerFocusContainer = document.getElementById('readerFocusContainer');
            const focusModeContent = document.getElementById('focusModeContent');
            const searchHistoryList = document.getElementById('searchHistoryList');

            const BOOK_FILES_PATH = 'tanach/';
            const SEARCH_HISTORY_KEY = 'bibleSearchHistory';
            let isGematriaSearchActive = false;
            
            const bookMapping = { "בראשית": ["בראשית.txt"], "שמות": ["שמות.txt"], "ויקרא": ["ויקרא.txt"], "במדבר": ["במדבר.txt"], "דברים": ["דברים.txt"], "יהושע": ["יהושע.txt"], "שופטים": ["שופטים.txt"], "שמואל": ["שמואל.txt"], "מלכים": ["מלכים.txt"], "ישעיהו": ["ישעיהו.txt"], "ירמיהו": ["ירמיהו.txt"], "יחזקאל": ["יחזקאל.txt"], "הושע": ["הושע.txt"], "יואל": ["יואל.txt"], "עמוס": ["עמוס.txt"], "עובדיה": ["עובדיה.txt"], "יונה": ["יונה.txt"], "מיכה": ["מיכה.txt"], "נחום": ["נחום.txt"], "חבקוק": ["חבקוק.txt"], "צפניה": ["צפניה.txt"], "חגי": ["חגי.txt"], "זכריה": ["זכריה.txt"], "מלאכי": ["מלאכי.txt"], "תהילים": ["תהילים.txt"], "משלי": ["משלי.txt"], "איוב": ["איוב.txt"], "שיר השירים": ["שיר השירים.txt"], "רות": ["רות.txt"], "איכה": ["איכה.txt"], "קהלת": ["קהלת.txt"], "אסתר": ["אסתר.txt"], "דניאל": ["דניאל.txt"], "עזרא ונחמיה": ["עזרא ונחמיה.txt"], "דברי הימים": ["דברי הימים.txt"] };
            const gematriaValues = { 'א': 1, 'ב': 2, 'ג': 3, 'ד': 4, 'ה': 5, 'ו': 6, 'ז': 7, 'ח': 8, 'ט': 9, 'י': 10, 'כ': 20, 'ל': 30, 'מ': 40, 'נ': 50, 'ס': 60, 'ע': 70, 'פ': 80, 'צ': 90, 'ק': 100, 'ר': 200, 'ש': 300, 'ת': 400, 'ך': 20, 'ם': 40, 'ן': 50, 'ף': 80, 'ץ': 90 };

            // === Event Listeners Setup ===
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
            
            function toggleMenu() {
                menuDropdown.classList.toggle('show');
                menuOverlay.classList.toggle('show');
            }
            hamburgerMenuBtn.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);

            openSidebarBtn.addEventListener('click', () => { toggleMenu(); sidebar.classList.add('open'); });
            openBookReadModalBtn.addEventListener('click', () => { toggleMenu(); openBookReadModal(); });
            const closeSidebarBtn = document.querySelector('#sidebar .closebtn');
            if(closeSidebarBtn) closeSidebarBtn.addEventListener('click', () => sidebar.classList.remove('open'));
            if(resetFiltersBtn) resetFiltersBtn.addEventListener('click', resetFilters);
            gematriaModeToggle.addEventListener('click', () => {
                isGematriaSearchActive = !isGematriaSearchActive;
                gematriaToggleText.textContent = isGematriaSearchActive ? 'בטל גימטריה' : 'חיפוש גימטריה';
                searchInput.placeholder = isGematriaSearchActive ? 'הזן ערך גימטרי (מספר או מילים)' : 'הזן מילים לחיפוש';
                if (isGematriaSearchActive) wholeWordToggle.checked = false;
                toggleMenu();
            });
            wholeWordToggle.addEventListener('change', () => {
                if(wholeWordToggle.checked) {
                    isGematriaSearchActive = false;
                    gematriaToggleText.textContent = 'חיפוש גימטריה';
                    searchInput.placeholder = 'הזן מילים לחיפוש';
                }
            });
            focusModeToggle.addEventListener('click', enterFocusMode);
            darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode', darkModeToggle.checked);
                localStorage.setItem('darkMode', darkModeToggle.checked);
            });
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }

            // === Font Size Controls with Number Display ===
            const decreaseResultsFontBtn = document.getElementById('decreaseResultsFont');
            const increaseResultsFontBtn = document.getElementById('increaseResultsFont');
            const decreaseReaderFontBtn = document.getElementById('decreaseReaderFont');
            const increaseReaderFontBtn = document.getElementById('increaseReaderFont');
            
            function initializeFontSizes() { updateFontSizeDisplay('results'); updateFontSizeDisplay('reader'); }
            function updateFontSizeDisplay(target) {
                const root = document.documentElement;
                const multiplier = parseFloat(root.style.getPropertyValue(`--${target}-font-size-multiplier`) || 1);
                const valueElement = document.getElementById(`${target}FontSizeValue`);
                if (valueElement) { valueElement.textContent = `${Math.round(multiplier * 100)}%`; }
            }
            function changeFontSize(target, change) {
                const root = document.documentElement;
                const multiplier = parseFloat(root.style.getPropertyValue(`--${target}-font-size-multiplier`) || 1);
                let newMultiplier = multiplier + change;
                if (newMultiplier < 0.5) newMultiplier = 0.5;
                if (newMultiplier > 2) newMultiplier = 2;
                root.style.setProperty(`--${target}-font-size-multiplier`, newMultiplier.toFixed(2));
                updateFontSizeDisplay(target);
            }
            if(decreaseResultsFontBtn) decreaseResultsFontBtn.addEventListener('click', () => changeFontSize('results', -0.1));
            if(increaseResultsFontBtn) increaseResultsFontBtn.addEventListener('click', () => changeFontSize('results', 0.1));
            if(decreaseReaderFontBtn) decreaseReaderFontBtn.addEventListener('click', () => changeFontSize('reader', -0.1));
            if(increaseReaderFontBtn) increaseReaderFontBtn.addEventListener('click', () => changeFontSize('reader', 0.1));
            initializeFontSizes();

            // === UI Functions ===
            function enterFocusMode() {
                if (resultsContainer.innerHTML.trim() === "") return;
                toggleMenu(); document.body.classList.add('focus-mode'); focusModeContent.innerHTML = resultsContainer.innerHTML;
            }
            window.exitFocusMode = () => document.body.classList.remove('focus-mode');
            window.closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';
            function resetFilters() {
                document.querySelectorAll('#bookList input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                searchButton.classList.remove('filtered');
            }
            
            document.addEventListener('click', (event) => {
                if (sidebar.classList.contains('open') && !sidebar.contains(event.target) && !openSidebarBtn.contains(event.target)) sidebar.classList.remove('open');
            });
            window.addEventListener('click', (event) => {
                if (event.target === fullTextModal) closeModal('fullTextModal');
                if (event.target === bookReadModal) closeModal('bookReadModal');
                if (event.target === readerModal) closeModal('readerModal');
            });
            if(bookList) bookList.addEventListener('change', () => {
                const selectedBooks = document.querySelectorAll('#bookList input:checked');
                searchButton.classList.toggle('filtered', selectedBooks.length > 0);
            });
            
            function populateBookList() {
                if (!bookList) return; bookList.innerHTML = '';
                for (const bookDisplayName in bookMapping) {
                    const li = document.createElement('li');
                    li.className = 'sidebar-book-item';
                    li.innerHTML = `<label>${bookDisplayName}<input type="checkbox" name="books" value="${bookDisplayName}"><span class="checkmark"></span></label>`;
                    bookList.appendChild(li);
                }
            }
            populateBookList();

            // === Search History Functions ===
            function getSearchHistory() { return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY)) || []; }
            function saveSearchTerm(term) {
                let history = getSearchHistory();
                if (history[0] === term) return; 
                history = history.filter(t => t !== term);
                history.unshift(term);
                if (history.length > 7) history.pop();
                localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
            }
            function renderSearchHistory() {
                const history = getSearchHistory();
                searchHistoryList.innerHTML = '';
                if (history.length === 0) {
                    searchHistoryList.innerHTML = `<li style="cursor:default; color:#7f8c8d;">אין היסטוריה</li>`;
                    return;
                }
                history.forEach(term => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-history"></i> ${term}`;
                    li.addEventListener('click', () => {
                        searchInput.value = term;
                        performSearch();
                        toggleMenu();
                    });
                    searchHistoryList.appendChild(li);
                });
            }
            renderSearchHistory();

            async function openBookReadModal() {
                if(!readBookList) return; readBookList.innerHTML = '';
                for (const bookDisplayName in bookMapping) {
                    const li = document.createElement('li');
                    li.classList.add('read-book-item'); li.textContent = bookDisplayName;
                    li.addEventListener('click', () => openReaderModal(bookMapping[bookDisplayName][0], bookDisplayName));
                    readBookList.appendChild(li);
                }
                bookReadModal.style.display = 'flex';
            }

            async function openReaderModal(bookFileName, bookName) {
                readerBookText.innerHTML = ''; loadingIndicator.style.display = 'block'; closeModal('bookReadModal');
                try {
                    const response = await fetch(BOOK_FILES_PATH + bookFileName);
                    if (!response.ok) throw new Error(`Failed to load ${bookFileName}`);
                    const fullText = await response.text();
                    readerBookTitle.textContent = bookName;
                    const formattedHtml = displayText(fullText.replace(/<B>(\d+:\d+)<\/B>/g, '<b>$1</b>'));
                    readerBookText.innerHTML = formattedHtml;
                    readerModal.style.display = 'flex';
                } catch (error) { readerBookText.innerHTML = `<p style="color: red;">שגיאה: ${error.message}</p>`; } 
                finally { loadingIndicator.style.display = 'none'; }
            }

            // === Text Processing Helper Functions ===
            function displayText(text) { return text.replace(/-+/g, ' ').replace(/{[^}]*}/g, '').replace(/[;.]/g, ''); }
            function cleanTextForSearch(text) { return text.replace(/<[^>]*>/g, '').replace(/[\u0590-\u05CF]/g, '').trim(); }
            function cleanTextForGematria(text) { return text.replace(/<[^>]*>|[.,:;'"!?()[\]{}]/g, '').replace(/-/g, ' ').replace(/\s+/g, ' ').trim(); }
            function calculateGematria(word) { return [...word].reduce((sum, char) => sum + (gematriaValues[char] || 0), 0); }
            
            // === Main Search Function ===
            async function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (!searchTerm) return;
                
                saveSearchTerm(searchTerm);
                renderSearchHistory();

                resultsContainer.innerHTML = ''; loadingIndicator.style.display = 'block';
                let foundCount = 0;
                
                const selectedBooks = Array.from(document.querySelectorAll('#bookList input:checked')).map(cb => cb.value);
                let filesToSearch = selectedBooks.length > 0 ? selectedBooks.flatMap(book => bookMapping[book]) : Object.values(bookMapping).flat();
                
                // === NEW: Advanced Search Logic ===
                let searchType = 'SIMPLE';
                let terms = [];
                let highlightTerms = [];

                if (searchTerm.includes(' וגם ')) {
                    searchType = 'AND';
                    terms = searchTerm.split(' וגם ').map(t => t.trim()).filter(t => t);
                    highlightTerms = terms;
                } else if (searchTerm.includes(' לא ')) {
                    searchType = 'NOT';
                    terms = searchTerm.split(' לא ').map(t => t.trim()).filter(t => t);
                    highlightTerms = [terms[0]]; // Only highlight the term that should be present
                } else {
                    terms = [searchTerm];
                    highlightTerms = [searchTerm];
                }

                let results = [];
                try {
                    for (const bookFileName of filesToSearch) {
                        const response = await fetch(BOOK_FILES_PATH + bookFileName);
                        if (!response.ok) continue;
                        const text = await response.text();
                        const bookName = Object.keys(bookMapping).find(key => bookMapping[key].includes(bookFileName));
                        const parts = text.split(/<B>|<\/B>/);
                        for (let i = 1; i < parts.length; i += 2) {
                            const verseLocation = parts[i].trim();
                            const originalVerseText = parts[i+1] ? parts[i+1].trim() : '';
                            const verseCleanedText = cleanTextForSearch(originalVerseText);
                            let match = false;

                            const createRegex = (term) => wholeWordToggle.checked 
                                ? new RegExp(`(^|[\\s,-])${cleanTextForSearch(term).replace(/([.*+?^${}()|\[\]\/\\])/g, '\\$1')}([\\s,-]|$)`, 'i') 
                                : new RegExp(cleanTextForSearch(term).replace(/([.*+?^${}()|\[\]\/\\])/g, '\\$1'), 'i');

                            switch (searchType) {
                                case 'AND':
                                    match = terms.every(term => createRegex(term).test(verseCleanedText));
                                    break;
                                case 'NOT':
                                    if (terms.length === 2) {
                                        match = createRegex(terms[0]).test(verseCleanedText) && !createRegex(terms[1]).test(verseCleanedText);
                                    }
                                    break;
                                case 'SIMPLE':
                                default:
                                    match = createRegex(terms[0]).test(verseCleanedText);
                                    break;
                            }

                            if (match) {
                                foundCount++;
                                results.push({ bookName, verseLocation, originalVerseText, highlightTerm: highlightTerms, bookFileName, isGematria: false });
                            }
                        }
                    }
                    
                    loadingIndicator.style.display = 'none';
                    const resultsHeader = document.createElement('div');
                    resultsHeader.className = 'results-header';
                    resultsHeader.innerHTML = `<h3>נמצאו ${foundCount} תוצאות</h3><div class="search-mode">חיפוש מתקדם</div>`;
                    resultsContainer.prepend(resultsHeader);
                    
                    if (foundCount > 0) {
                        results.forEach((result, index) => {
                            displayVerseCard(result, index);
                        });
                    } else {
                        resultsContainer.innerHTML += `<p style="text-align: center; color: #7f8c8d;">לא נמצאו תוצאות עבור '${searchTerm}'.</p>`;
                    }

                } catch (error) { 
                    loadingIndicator.style.display = 'none';
                    resultsContainer.innerHTML = `<p style="text-align: center; color: red;">אירעה שגיאה: ${error.message}</p>`; 
                }
            }

            function displayVerseCard(resultData, index) {
                const { bookName, verseLocation, originalVerseText, highlightTerm, bookFileName, isGematria, gematriaValue } = resultData;
                const verseCard = document.createElement('div');
                verseCard.className = 'verse-card';
                const locationHTML = isGematria ? `${bookName} | ${verseLocation} <span class="gematria-value">(ערך: ${gematriaValue})</span>` : `${bookName} | ${verseLocation}`;
                verseCard.innerHTML = `<div class="verse-location">${locationHTML}</div><div class="verse-text"></div>`;
                const verseTextElem = verseCard.querySelector('.verse-text');
                
                let textForDisplay = displayText(originalVerseText);
                let highlightedText = textForDisplay;

                const termsToHighlight = Array.isArray(highlightTerm) ? highlightTerm : [highlightTerm];

                termsToHighlight.forEach(term => {
                    const flexibleHighlight = cleanTextForSearch(term).split('').join('[\\u0590-\\u05CF]*');
                    if (wholeWordToggle.checked) {
                        const regex = new RegExp(`(^|[\\s,-])(${flexibleHighlight})([\\s,-]|$)`, 'gi');
                        highlightedText = highlightedText.replace(regex, `$1<span class="highlight">$2</span>$3`);
                    } else {
                        const regex = new RegExp(`(${flexibleHighlight})`, 'gi');
                        highlightedText = highlightedText.replace(regex, `<span class="highlight">$1</span>`);
                    }
                });
                
                verseTextElem.innerHTML = highlightedText;
                resultsContainer.appendChild(verseCard);
                
                setTimeout(() => {
                    verseCard.classList.add('visible');
                }, index * 100);

                verseCard.addEventListener('click', () => openFullTextModal(bookFileName, bookName));
            }

            async function openFullTextModal(bookFileName, bookName) {
                modalBookText.innerHTML = ''; loadingIndicator.style.display = 'block';
                try {
                    const response = await fetch(BOOK_FILES_PATH + bookFileName);
                    if (!response.ok) throw new Error(`Failed to load ${bookFileName}`);
                    const fullText = await response.text();
                    modalBookTitle.textContent = bookName;
                    modalBookText.innerHTML = displayText(fullText.replace(/<B>(\d+:\d+)<\/B>/g, '<b>$1</b>'));
                    fullTextModal.style.display = 'flex';
                } catch (error) { modalBookText.innerHTML = `<p style="color: red;">שגיאה: ${error.message}</p>`; } 
                finally { loadingIndicator.style.display = 'none'; }
            }
        });
    </script>
</body>
</html>
