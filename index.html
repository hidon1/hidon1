<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חידון התנ"ך</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
             height: 100%;
             margin: 0;
             padding: 0;
             font-family: 'Rubik', sans-serif; /* Changed font here */
             direction: rtl;
             text-align: center;
             background: linear-gradient(to bottom, #a7d7c5, #f7f7f7); /* Fallback background */
             color: #333;
             box-sizing: border-box;
             overflow-y: auto;
             position: relative;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 10px;
        }

        /* Background overlay for Stage image */
        #background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            /* Adjusted opacity to 50% as requested */
            opacity: 0.5; /* Changed from 0.15 to 0.5 */
            z-index: -1;
            pointer-events: none;
            transition: background-image 0.5s ease-in-out; /* Smooth transition for background image change */
        }


        .container {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 1100px;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
    font-size: 1.15em;
}

        .quiz-section {
             /* Adjusted padding: top/bottom 15px, further reduced left/right padding */
             padding: 15px 3px; /* Changed from 5px to 3px for slightly wider buttons */
             border-radius: 10px;
             background-color: #f9f9f9;
             box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
             box-sizing: border-box;
             /* Ensure quiz-section content is centered if it doesn't fill the width */
             align-items: center; /* This is already in the combined rule, but good to keep in mind */
             justify-content: center; /* Added for centering content vertically if needed */
        }

         /* New: Style for the initial intro screen */
        #initial-intro {
             display: flex; /* Initially visible */
             flex-direction: column;
             align-items: center;
             justify-content: center; /* Center content vertically */
             gap: 20px; /* Space between logo and button */
             min-height: 300px; /* Give it a minimum height */
        }

        /* Style for the SVG logo within the initial intro - Scaled Down */
         #initial-intro svg {
             max-width: 100%; /* Ensure SVG scales down if needed */
             /* Added max-height to limit the logo size - Adjusted value */
             max-height: 250px; /* Adjusted from 300px to 250px */
             height: auto; /* Maintain aspect ratio */
         }

         /* Style for the initial start button */
         #initial-start-button {
             padding: 15px 30px;
             font-size: 1.5em;
             cursor: pointer;
             background-color: #007bff; /* Blue color */
             color: white;
             border: none;
             border-radius: 8px;
             transition: background-color 0.3s ease;
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
             font-weight: bold;
         }
          #initial-start-button:hover {
              background-color: #0056b3; /* Darker blue */
          }


        /* All main screens are flex containers when visible */
        #stage-intro, #advanced-stage-screen, #stage-summary, #quiz-area {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 12px; /* Slightly increased gap within sections */
        }
         /* Override for intro screen if different gap is preferred, currently same as others */
         /* #stage-intro { gap: 10px; } */


        /* Crucial: Use !important to ensure display: none overrides any other display property */
        .hidden {
            display: none !important;
        }


        h1 {
            color: #2c3e50;
            margin-bottom: 0;
            font-size: 2.2em; /* Slightly increased font size */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        h2 {
             color: #34495e;
             font-size: 1.7em; /* Slightly increased font size */
             margin-top: 0;
             margin-bottom: 8px;
        }
         /* Style for the advanced stage screen title */
        #advanced-stage-screen h2 {
             color: #27ae60; /* Green color for success message */
        }


        /* Removed #quiz-area from the flex/gap group above, restyled individually */
         /* #quiz-area display and gap now handled in the combined rule above */


        /* סגנון הטיימר הויזואלי (סרגל התקדמות) */
        #timer-bar-container {
            width: 100%;
            height: 12px; /* Slightly increased timer bar height */
            background-color: #ecf0f1;
            border-radius: 6px; /* Adjusted border-radius */
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        #timer-bar {
            width: 100%;
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.75s linear;
            border-radius: 6px; /* Adjusted border-radius */
        }

        /* צבעי הטיימר כשהזמן אוזל */
        #timer-bar.warning {
            background-color: #f39c12;
        }

         #timer-bar.critical {
            background-color: #e74c3c;
        }


        #dashboard {
            background-color: #34495e;
            color: #fff;
            padding: 12px; /* Increased padding */
            border-radius: 8px;
            font-size: 1em; /* Slightly increased font size */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 8px; /* Adjusted gap */
            box-sizing: border-box;
        }

        #dashboard span {
            margin: 0 4px; /* Adjusted margin */
            font-weight: bold;
        }
         /* Adjust specific dashboard spans for clarity */
        #dashboard span strong { /* Make the labels bold */
             font-weight: bold;
             color: #fff;
         }
          #dashboard span span { /* Make the values normal weight */
             font-weight: normal;
             color: #ecf0f1; /* Lighter color for values */
          }


        #question-text {
            font-size: 1.3em; /* Slightly increased font size */
            margin-bottom: 10px; /* Adjusted margin */
            min-height: 60px; /* Increased min-height */
            color: #2c3e50;
            line-height: 1.5; /* Adjusted line-height */
        }

        #answer-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    width: 100%;
    margin-bottom: 10px;
    justify-items: center;
}

        .answer-button {
    padding: 15px;
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    background-color: #a8e6e6;
    transition: background 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
    font-size: 1em;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: none;
    box-sizing: border-box;
}
.answer-button:hover {
    background-color: #9adede;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}
.answer-button:active {
    transform: scale(0.97);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

        .answer-button:hover {
    background-color: #9adede;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

         .answer-button:active {
             transform: scale(0.98);
         }

        .answer-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }

        #intro-button, #advanced-stage-button, #summary-button { /* Renamed start button and added summary button style */
            padding: 12px 25px; /* Increased padding */
            font-size: 1.2em; /* Increased font size */
            cursor: pointer;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        #intro-button:hover, #advanced-stage-button:hover, #summary-button:hover {
            background-color: #27ae60;
             box-shadow: 0 2px 7px rgba(0, 0, 0, 0.3);
        }
        #intro-button:active, #advanced-stage-button:active, #summary-button:active {
             transform: scale(0.98);
         }
         /* Different color for restart/play again button */
        #summary-button {
             background-color: #3498db;
             margin-top: 20px; /* Increased space below summary text */
        }
         #summary-button:hover {
             background-color: #2980b9;
         }


        #feedback {
            font-weight: bold;
            margin-top: 10px;
            min-height: 18px; /* Keep some space even if text is removed */
            font-size: 0.9em;
            /* Removed opacity transition, handled by display: none */
        }

         /* Style for the Skip button */
        #skip-button {
             padding: 10px 20px;
             font-size: 1em;
             cursor: pointer;
             background-color: #f39c12; /* Orange color */
             color: white;
             border: none;
             border-radius: 6px;
             transition: background-color 0.3s ease, transform 0.1s ease;
             box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
             font-weight: bold;
             margin-top: 5px; /* Space above it */
        }
         #skip-button:hover:not(:disabled) {
             background-color: #e67e22; /* Darker orange */
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
         }
          #skip-button:active:not(:disabled) {
              transform: scale(0.98);
          }
         #skip-button:disabled {
             cursor: not-allowed;
             opacity: 0.5;
             box-shadow: none;
         }


        .correct {
            color: #27ae60; /* This class is still used for button highlighting */
        }

        .incorrect {
            color: #c0392b; /* This class is still used for button highlighting */
        }

        /* סגנון לכפתורים לאחר מענה (מדגישים ירוק/אדום) */
        .answer-button[data-correct="true"][style*="background-color"] {
             background-color: #2ecc71 !important;
             border-color: #27ae60;
             color: white;
        }
         .answer-button[data-correct="false"][style*="background-color"] {
             background-color: #e74c3c !important;
             border-color: #c0392b;
              color: white;
        }


         /* Basic responsiveness */
         @media (max-width: 870px) { /* Adjusted breakpoint based on new max-width + padding */
              .container {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 1100px;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
    font-size: 1.15em;
}
         }
         @media (max-width: 650px) { /* Adjusted breakpoint */
             body { padding: 8px; } /* Adjusted padding */
             .container {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 1100px;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
    font-size: 1.15em;
}
             .quiz-section {
                 /* Adjusted padding for smaller screens */
                 padding: 10px 8px;
             }
             #answer-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    width: 100%;
    margin-bottom: 10px;
    justify-items: center;
}
             #dashboard {
                 flex-direction: column;
                 align-items: center;
                 padding: 8px; /* Adjusted padding */
                 gap: 4px; /* Adjusted gap */
             }
             #dashboard span {
                 margin: 1px 0;
             }
              h1 { font-size: 1.8em; } /* Adjusted font size */
              h2 { font-size: 1.4em; } /* Adjusted font size */
              #question-text { font-size: 1.1em; min-height: 50px;} /* Adjusted font size */
              .answer-button, #intro-button, #advanced-stage-button, #summary-button { font-size: 1em; padding: 10px; } /* Adjusted font size and padding */
              #feedback { font-size: 0.9em; min-height: 18px;} /* Adjusted font size */
              #skip-button { padding: 8px 15px; font-size: 0.9em;} /* Adjusted skip button on small screens */
         }
         @media (max-width: 450px) { /* Adjusted breakpoint */
              h1 { font-size: 1.5em; } /* Adjusted font size */
              h2 { font-size: 1.2em; } /* Adjusted font size */
              #question-text { font-size: 1em; min-height: 40px;} /* Adjusted font size */
              .answer-button {
    padding: 15px;
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    background-color: #a8e6e6;
    transition: background 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
    font-size: 1em;
    text-align: center;
    color: #2c3e50;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: none;
    box-sizing: border-box;
}
.answer-button:hover {
    background-color: #9adede;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}
.answer-button:active {
    transform: scale(0.97);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
} /* Adjusted padding */
              .container {
    background-color: #ffffff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 1100px;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
    font-size: 1.15em;
}
         }

    
.fade-in {
    animation: fadeIn 0.6s ease-in-out forwards;
}
.fade-out {
    animation: fadeOut 0.6s ease-in-out forwards;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-20px); }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div id="background-overlay"></div>


    <div class="container">

        <div id="initial-intro" class="quiz-section">
             <svg width="600" height="600" viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg">
               <defs>
                 <linearGradient id="balloonGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                   <stop offset="0%" stop-color="#e0b8ff"/>
                   <stop offset="40%" stop-color="#9932cc"/>
                   <stop offset="80%" stop-color="#6a0dad"/>
                   <stop offset="100%" stop-color="#4b0082"/>
                 </linearGradient>

                 <filter id="balloonEffect" x="-20%" y="-20%" width="140%" height="140%">
                   <feOffset result="offOut" in="SourceAlpha" dx="6" dy="6"/>
                   <feGaussianBlur result="blurOut" in="offOut" stdDeviation="3"/>
                   <feBlend in="SourceGraphic" in2="blurOut" mode="normal"/>
                 </filter>

                 <filter id="extraBold" x="-10%" y="-10%" width="120%" height="120%">
                   <feMorphology operator="dilate" radius="1.5" in="SourceGraphic" result="dilated"/>
                   <feGaussianBlur stdDeviation="1" in="dilated" result="blurred"/>
                   <feComposite in="SourceGraphic" in2="blurred" operator="over"/>
                 </filter>
               </defs>

               <circle cx="300" cy="300" r="270" fill="#d60000" stroke="#0046ad" stroke-width="20"/>

               <circle cx="300" cy="300" r="240" fill="none" stroke="purple" stroke-width="5" stroke-opacity="0.5"/>

               <text x="300" y="250"
                     font-size="125"
                     font-family="Tahoma, Verdana, 'Segoe UI', sans-serif"
                     font-weight="900"
                     fill="url(#balloonGradient)"
                     text-anchor="middle"
                     letter-spacing="3"
                     filter="url(#balloonEffect) url(#extraBold)">
                 חידון
               </text>

               <text x="300" y="380"
                     font-size="125"
                     font-family="Tahoma, Verdana, 'Segoe UI', sans-serif"
                     font-weight="900"
                     fill="url(#balloonGradient)"
                     text-anchor="middle"
                     letter-spacing="3"
                     filter="url(#balloonEffect) url(#extraBold)">
                 התנ״ך
               </text>
             </svg>
             <button id="initial-start-button">התחל</button>
        </div>


        <div id="stage-intro" class="quiz-section hidden">
            <h1>חידון התנ"ך</h1>
            <h2 id="stage-theme">טוען...</h2>
            <button id="intro-button">התחל שלב</button>
        </div>

        <div id="advanced-stage-screen" class="quiz-section hidden">
            <h2>כל הכבוד!</h2>
            <p>סיימת את שלב <span id="completed-stage-num-adv">?</span> בהצלחה.</p>
            <p>התקדמת לשלב <span id="next-stage-num-adv">?</span>: <span id="next-stage-theme-adv">?</span></p>
            <button id="advanced-stage-button">התחל שלב הבא</button>
        </div>

        <div id="quiz-area" class="quiz-section hidden">
            
    <div id="timer-container" style="width:60px; height:60px; position:relative;">
      <svg width="60" height="60" viewBox="0 0 36 36">
        <circle cx="18" cy="18" r="16" fill="none" stroke="#ecf0f1" stroke-width="2"></circle>
        <circle id="timer-circle" cx="18" cy="18" r="16" fill="none" stroke="#2ecc71" stroke-width="2"
                stroke-dasharray="100, 100" stroke-linecap="round" transform="rotate(-90 18 18)">
        </circle>
        <text id="timer-text" x="18" y="22" font-size="8" text-anchor="middle" fill="#34495e">20</text>
      </svg>
    </div>
    
            <div id="question-text"></div>
            <div id="answer-options">
                </div>
            <div id="feedback" class="hidden"></div>
             <button id="skip-button" class="hidden">דלג על שאלה (-50 נקודות)</button>
        </div>

        <div id="stage-summary" class="quiz-section hidden">
            <h2>סיכום שלב</h2>
            <p id="stage-summary-score-text">ניקוד לשלב זה: <span id="final-stage-score"></span> מתוך <span id="max-stage-score"></span></p>
             <p id="total-score-summary">ניקוד כולל: <span id="final-total-score"></span></p>
            <p id="stage-result"></p>
            </div>

        <div id="celebration-message" class="hidden" style="font-size: 2em; color: #e67e22; font-weight: bold; margin: 10px 0;"></div>

<div id="dashboard" class="hidden">
            <span id="stage-info"><strong>שלב</strong> <span id="current-stage">1</span>: <span id="current-stage-theme"></span></span> |
            <span id="question-info"><strong>שאלה</strong> <span id="current-question-num">0</span> מתוך <span id="total-stage-questions">10</span></span> |
            <span id="score-info"><strong>ניקוד שלב</strong> <span id="stage-score">0</span></span> | <span id="total-score-info"><strong>ניקוד כולל</strong> <span id="total-quiz-score">0</span></span> | <span id="timer-info"><strong>זמן</strong> <span id="time-left">20</span></span>
        </div>

    </div>

    <script>
        // JSON data now structured as an array of stages
        const quizData = [];

        // Array to store points per stage (index 0 is Stage 1, index 1 is Stage 2, etc.)
        const pointsPerStage = [5, 5, 5, 5, 5, 5]; // Add more values here for additional stages

        // Get references to HTML elements
        // New: Reference to initial intro screen and button
        const initialIntro = document.getElementById('initial-intro');
        const initialStartButton = document.getElementById('initial-start-button');


        const stageIntro = document.getElementById('stage-intro');
        const stageThemeSpan = document.getElementById('stage-theme'); // Used in intro screen
        const introButton = document.getElementById('intro-button'); // Renamed button

         // New: Advanced Stage Screen elements
        const advancedStageScreen = document.getElementById('advanced-stage-screen');
        const completedStageNumAdvSpan = document.getElementById('completed-stage-num-adv'); // New span for completed stage number
        const nextStageNumAdvSpan = document.getElementById('next-stage-num-adv');
        const nextStageThemeAdvSpan = document.getElementById('next-stage-theme-adv');
        const advancedStageButton = document.getElementById('advanced-stage-button');


        const quizArea = document.getElementById('quiz-area');
        const dashboard = document.getElementById('dashboard');
        const currentStageSpan = document.getElementById('current-stage');
        const currentStageThemeSpan = document.getElementById('current-stage-theme'); // New span for theme in dashboard
        const currentQuestionNumSpan = document.getElementById('current-question-num');
        const totalStageQuestionsSpan = document.getElementById('total-stage-questions');
        const stageScoreSpan = document.getElementById('stage-score'); // Score for the current stage
        const totalQuizScoreSpan = document.getElementById('total-quiz-score'); // Added span for total score
        const timeLeftSpan = document.getElementById('time-left');
        const timerBar = document.getElementById('timer-bar');
        const questionTextDiv = document.getElementById('question-text');
        const answerOptionsDiv = document.getElementById('answer-options');
        const feedbackDiv = document.getElementById('feedback'); // Kept hidden for space
         // New Skip Button element reference
        const skipButton = document.getElementById('skip-button');

        const stageSummary = document.getElementById('stage-summary');
        const finalStageScoreSpan = document.getElementById('final-stage-score');
        const maxStageScoreSpan = document.getElementById('max-stage-score'); // Span for max stage score in summary
        const totalScoreSummarySpan = document.getElementById('final-total-score'); // Added span for total score in summary
        const stageResultPara = document.getElementById('stage-result');
        const stageSummaryScoreText = document.getElementById('stage-summary-score-text'); // Text element for stage score in summary
        const totalScoreSummaryText = document.getElementById('total-score-summary'); // Text element for total score in summary
        const backgroundOverlay = document.getElementById('background-overlay');
        let summaryButton = null; // Reference to the button in the summary screen


        // Quiz state variables
        let currentStageIndex = 0;
        let currentQuestionIndexInStage = 0;
        let stageScore = 0; // Score for the current stage only
        let totalQuizScore = 0; // Total score across all stages
        let selectedQuestionsForStage = []; // The 10 random questions for the current stage
        let timerInterval = null;
        const TIME_PER_QUESTION = 20;
        let timeLeft = TIME_PER_QUESTION;
        const QUESTIONS_PER_STAGE = 10; // Number of questions to select for each stage
        const SKIP_COST = 50; // Cost to skip a question

        // New variable to track correct answers OR skips for stage passing
        let correctOrSkippedCount = 0;


        const ANSWER_HIGHLIGHT_DELAY = 750; // Delay to show highlight before moving to next question


        // --- Functions ---

        // Fisher-Yates (Knuth) Shuffle algorithm
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Set background image based on the current stage
        function setBackgroundForCurrentStage() {
             console.log("Setting background for stage index:", currentStageIndex);
             // Check if the current stage index is valid and has background_image data
             if (currentStageIndex >= 0 && currentStageIndex < quizData.length && quizData[currentStageIndex].background_image) {
                 // Use the background_image path stored during JSON loading
                 backgroundOverlay.style.backgroundImage = `url('${quizData[currentStageIndex].background_image}')`;
             } else {
                 // Fallback or clear background if no image defined for the stage
                 backgroundOverlay.style.backgroundImage = ''; // Clears the background
             }
        }

        // Hide all screens by adding the 'hidden' class
        function hideAllScreens() {
             // Hide all main content screens
            initialIntro.classList.add('hidden');
            stageIntro.classList.add('hidden');
            quizArea.classList.add('hidden');
            stageSummary.classList.add('hidden');
            dashboard.classList.add('hidden');
            advancedStageScreen.classList.add('hidden');

             // Ensure skip button is hidden when screens are generally hidden
             skipButton.classList.add('hidden');
             // Clear background when no specific stage screen is shown
             backgroundOverlay.style.backgroundImage = '';
        }

         // Show the initial intro screen
        function showInitialIntro() {
             console.log("--- showInitialIntro called ---");
             hideAllScreens(); // Hide everything first

             // The initial intro screen is the only one that should be visible
             initialIntro.classList.remove('hidden');

             // No background image for the initial intro
             backgroundOverlay.style.backgroundImage = ''; // Already done in hideAllScreens, but explicit here too

             console.log("Initial intro screen showing.");
             // Add a log to confirm the button element is found here
             console.log('Initial start button element:', initialStartButton);
        }


        // Show the intro screen for a specific stage
        function showStageIntro(stageIndex) {
             console.log("--- showStageIntro called for stage index:", stageIndex, "---");
             hideAllScreens(); // Hide everything first

            // Check if this stage exists and has enough questions data and points data
             if (stageIndex >= quizData.length || !quizData[stageIndex].questions || quizData[stageIndex].questions.length < QUESTIONS_PER_STAGE || stageIndex >= pointsPerStage.length) { // Also check points data
                 console.error("Attempted to show intro for non-existent or incomplete stage data:", stageIndex);
                 endQuiz(true); // Assume quiz is finished if no more stages or not enough data
                 return;
             }

             // Set background for the stage we are introducing
             // Use the currentStageIndex which is the index of the stage we are about to start
             currentStageIndex = stageIndex; // Make sure currentStageIndex is set correctly
             setBackgroundForCurrentStage();


            stageIntro.classList.remove('hidden'); // Show the intro screen

            // Update the button text with the correct stage number
            introButton.textContent = `התחל שלב ${stageIndex + 1}`;
            stageThemeSpan.textContent = quizData[stageIndex].theme;

             // Ensure intro button is visible
             introButton.classList.remove('hidden'); // The parent div handles hiding/showing the block


            console.log("Intro screen showing for stage:", stageIndex + 1);
        }

         // Show the advanced stage screen (between stages)
        function showAdvancedStageScreen() {
             console.log("--- showAdvancedStageScreen called for stage index:", currentStageIndex + 1, "---");
             hideAllScreens(); // Hide everything first

             // Set background for the *next* stage in anticipation
             const nextStageIndex = currentStageIndex + 1;
             // Set the background using the data for the *next* stage
             if (nextStageIndex < quizData.length) {
                 // Temporarily update currentStageIndex to use setBackgroundForCurrentStage correctly
                 const originalStageIndex = currentStageIndex;
                 currentStageIndex = nextStageIndex; // Set to the index of the *next* stage
                 setBackgroundForCurrentStage(); // Use the main function
                 currentStageIndex = originalStageIndex; // Restore original index
             } else {
                  backgroundOverlay.style.backgroundImage = ''; // Clear background if next stage doesn't exist
             }

            advancedStageScreen.classList.remove('hidden'); // Show the advanced stage screen

            // Update text to reflect the completed and next stage numbers
            completedStageNumAdvSpan.textContent = currentStageIndex + 1; // The stage that was just completed (1-based)
            // Check bounds for next stage data
            const nextStageTheme = (nextStageIndex < quizData.length && quizData[nextStageIndex].theme) ? quizData[nextStageIndex].theme : 'השלב הבא';
            nextStageNumAdvSpan.textContent = nextStageIndex + 1; // Next stage number (1-based)
            nextStageThemeAdvSpan.textContent = nextStageTheme;

            // Select message based on the stage *just completed* (currentStageIndex before incrementing for next stage)
            const msg = stageMessages[currentStageIndex] || "שלב נוסף הושלם!"; // Use index of completed stage
            showCelebrationMessage(msg);

            triggerConfetti(currentStageIndex + 1); // Trigger confetti based on completed stage number (1-based)


             console.log("Advanced stage screen showing, next stage:", nextStageIndex + 1);
        }


        // Initialize the quiz - show intro for the first stage
        function initQuiz() {
             console.log("--- initQuiz called ---");

            // Reset total score only at the very start of the quiz
            totalQuizScore = 0; // Reset total score
             stageScore = 0; // Reset stage score
             correctOrSkippedCount = 0; // Reset success/skip count for the very first stage


            // Check if basic data exists (at least one stage, points data for first stage)
            if (!quizData || quizData.length === 0 || !quizData[0].questions || quizData[0].questions.length < QUESTIONS_PER_STAGE || pointsPerStage.length === 0) {
                // Display error on the initial intro screen
                 // Using the already existing initialIntro structure
                 const initialIntroElement = document.getElementById('initial-intro');
                 if (initialIntroElement) {
                     initialIntroElement.innerHTML = `
                        <h1>חידון התנ"ך</h1>
                        <p style="color: red;">שגיאה: לא נמצאו מספיק שאלות לשלב הראשון (צריך לפחות ${QUESTIONS_PER_STAGE}) או שהגדרת הניקוד לשלבים אינה מלאה.</p>
                     `;
                 }
                 // Ensure only the initial intro is visible to show the error message
                 hideAllScreens();
                 initialIntroElement.classList.remove('hidden');
                 dashboard.classList.add('hidden'); // Ensure dashboard is hidden
                 backgroundOverlay.style.backgroundImage = ''; // Clear background
                return;
            }

            // --- Add event listeners only once ---
            // Removed the if (!initialStartButton.dataset.listenerAdded) check for debugging
            // This ensures the listener is always added on load.
            initialStartButton.addEventListener('click', () => {
                console.log('Initial start button clicked!'); // Log when the button is clicked
                // Hide initial intro and show the first stage intro
                hideAllScreens(); // Hide the initial intro screen
                console.log('hideAllScreens called'); // Log after hiding
                showStageIntro(0); // Show intro for stage 1
                console.log('showStageIntro(0) called'); // Log after showing
            });


            if (!introButton.dataset.listenerAdded) {
                 introButton.addEventListener('click', startStage);
                 introButton.dataset.listenerAdded = 'true'; // Mark as added
            }
             // Changed check from dataset to checking if listenerAdded is true
             if (!advancedStageButton.dataset.listenerAdded) {
                 advancedStageButton.addEventListener('click', () => {
                    currentStageIndex++; // Increment stage index BEFORE starting the next stage
                    startStage(); // Start the quiz for the *new* currentStageIndex
                });
                 advancedStageButton.dataset.listenerAdded = 'true'; // Mark as added
             }
             // Add listener for the skip button only once
             if (!skipButton.dataset.listenerAdded) {
                 skipButton.addEventListener('click', skipQuestion);
                 skipButton.dataset.listenerAdded = 'true'; // Mark as added
             }


            currentStageIndex = 0; // Start with the first stage


            // Start by showing the initial intro screen
             hideAllScreens(); // Hide all screens first
            showInitialIntro(); // Show the initial logo screen

             console.log("initQuiz finished. Showing initial intro. Total score:", totalQuizScore);
        }


        // Start the current stage (generalized for any stage index)
        function startStage() {
            console.log("--- startStage called for stage index:", currentStageIndex, "---");

             // Check if this stage exists and has enough questions and points data
            if (currentStageIndex >= quizData.length || !quizData[currentStageIndex].questions || quizData[currentStageIndex].questions.length < QUESTIONS_PER_STAGE || currentStageIndex >= pointsPerStage.length) {
                 console.error("Cannot start stage:", currentStageIndex, ". Data not found or not enough questions or points data.");
                 // This should ideally not happen if flow is correct, but handle defensively
                 endQuiz(true); // Assume quiz is finished if no more stages available to start
                 return;
            }

             // Remove existing summary button if it exists from previous play
             if(summaryButton) {
                 summaryButton.remove();
                 summaryButton = null; // Clear reference
             }

             // Reset stage state at the start of EACH stage attempt
             currentQuestionIndexInStage = 0;
             stageScore = 0; // Reset stage score for this attempt
             correctOrSkippedCount = 0; // Reset success/skip count for this attempt


            feedbackDiv.classList.add('hidden'); // Ensure feedback text is hidden
            feedbackDiv.textContent = ''; // Clear any previous text


            // Hide all other screens and show quiz area and dashboard
            hideAllScreens(); // Hide all screens first
            quizArea.classList.remove('hidden');
            dashboard.classList.remove('hidden');
             skipButton.classList.remove('hidden'); // Show the skip button


            // Select 10 random questions for the current stage
            const allQuestionsForCurrentTheme = quizData[currentStageIndex].questions;
            const shuffledQuestions = shuffleArray([...allQuestionsForCurrentTheme]);
            selectedQuestionsForStage = shuffledQuestions.slice(0, QUESTIONS_PER_STAGE);

            console.log("Selected questions for stage (" + selectedQuestionsForStage.length + "):", selectedQuestionsForStage);

            // Update dashboard stage number, theme, and total questions
            updateDashboard();

            // Set background image for the current stage (called AFTER hiding other screens)
            setBackgroundForCurrentStage();

            displayQuestion(); // Display the first question
        }

        // Display the current question
        function displayQuestion() {
            console.log("--- displayQuestion called for index:", currentQuestionIndexInStage, "---");

            if (currentQuestionIndexInStage >= QUESTIONS_PER_STAGE) {
                console.log("End of stage condition met. Index:", currentQuestionIndexInStage);
                endStage(); // Go to end stage logic
                return;
            }

            const question = selectedQuestionsForStage[currentQuestionIndexInStage];

            // Added checks here to prevent the TypeError if data is malformed
            if (!question || !question.options || !Array.isArray(question.options)) {
                console.error("שגיאה: נתוני שאלה שגויים או חסרים עבור שאלה באינדקס:", currentQuestionIndexInStage, "בשאלות שנבחרו לשלב.");
                 console.log("Question object:", question); // Log the problematic question object
                 alert("שגיאה בטעינת השאלה. ייתכן שיש בעיה במבנה קובץ ה-JSON.");
                 // Optionally skip this question or end the stage
                 currentQuestionIndexInStage++; // Skip to the next question
                 displayQuestion(); // Try displaying the next one
                 return; // Stop processing this bad question
            }


            console.log("Processing question ID:", question.id, "Text:", question.text ? question.text.substring(0, 50) + "..." : "No text"); // Added check for text

            updateDashboard(); // Update dashboard at the start of displaying each question
            updateSkipButtonState(); // Update skip button state based on total score

            questionTextDiv.textContent = question.text || 'טקסט שאלה חסר'; // Display placeholder if text is missing

            answerOptionsDiv.innerHTML = ''; // Clear previous options

            const shuffledOptions = shuffleArray([...question.options]);
            // Ensure correct answer index is valid
            const originalCorrectAnswerText = (question.correctAnswerIndex >= 0 && question.correctAnswerIndex < question.options.length)
                                             ? question.options[question.correctAnswerIndex]
                                             : null; // Set to null if index is invalid


            shuffledOptions.forEach((optionText) => {
                const button = document.createElement('button');
                button.classList.add('answer-button');
                button.textContent = optionText;
                // Check if originalCorrectAnswerText is not null before comparing
                if (originalCorrectAnswerText !== null && optionText === originalCorrectAnswerText) {
                    button.dataset.correct = 'true';
                } else {
                     button.dataset.correct = 'false';
                }

                button.addEventListener('click', handleAnswerClick);
                answerOptionsDiv.appendChild(button);
            });

            // Enable buttons at the start of a new question
            enableAnswerAndSkipButtons(); // Re-enable all buttons

            resetTimer(); // Start timer for the new question
            startTimer();
            console.log("Timer reset and started for question index", currentQuestionIndexInStage);

            // TODO: Add sound effect for new question or timer start?
        }

        // Handle user clicking an answer
        function handleAnswerClick(event) {
             console.log("--- handleAnswerClick called ---");
            stopTimer(); // Stop timer as soon as an answer is clicked

            const selectedButton = event.target;
            // Check if the click was actually on a button (event delegation safety)
            if (!selectedButton.classList.contains('answer-button') || selectedButton.disabled) {
                 console.warn("Click was not on an enabled answer button.");
                 return; // Do nothing if clicked on disabled or non-button element
            }

            const isCorrect = selectedButton.dataset.correct === 'true';
            console.log("Selected answer:", selectedButton.textContent, "Is Correct:", isCorrect);

            // Disable all buttons and skip button after an answer is selected
            disableAnswerAndSkipButtons();

            // --- No text feedback here, just highlight ---
            const pointsForThisStage = pointsPerStage[currentStageIndex]; // Get points for the current stage
            if (isCorrect) {
                stageScore += pointsForThisStage; // Add to current stage score based on stage points
                 totalQuizScore += pointsForThisStage; // Add to TOTAL score immediately
                 correctOrSkippedCount++; // Increment success/skip count for correct answer
                 selectedButton.style.backgroundColor = '#2ecc71'; // Green highlight
                 // TODO: Play correct answer sound
            } else {
                 selectedButton.style.backgroundColor = '#e74c3c'; // Red highlight
                 // Highlight the correct one in green after a wrong answer
                 Array.from(answerOptionsDiv.children).forEach(button => {
                    if (button.dataset.correct === 'true') {
                        button.style.backgroundColor = '#2ecc71';
                    }
                 });
                 // TODO: Play wrong answer sound
                 // correctOrSkippedCount is NOT incremented for incorrect answers
            }

            updateDashboard(); // Update dashboard immediately after scoring (score changes)
            console.log("Highlight shown, score updated. Current stage score:", stageScore, "Total score:", totalQuizScore, "Success/Skipped:", correctOrSkippedCount);


            // Move to the next question after a short delay to see the highlight
            console.log("Setting timeout (" + ANSWER_HIGHLIGHT_DELAY + "ms) to display next question...");
            setTimeout(() => {
                 console.log("--- Timeout callback executing (handleAnswerClick) ---");
                 // Reset button styles before clearing content for safety
                 Array.from(answerOptionsDiv.children).forEach(button => {
                     button.style.backgroundColor = ''; // Reset to default/CSS
                 });
                 // Re-enable buttons is done in displayQuestion when new question is loaded
                currentQuestionIndexInStage++;
                displayQuestion(); // Move to next question
                // feedbackDiv remains hidden
            }, ANSWER_HIGHLIGHT_DELAY); // Use specified delay
        }

         // Handle skipping a question
         function skipQuestion() {
             console.log("--- skipQuestion called ---");

             if (totalQuizScore >= SKIP_COST) {
                 console.log("Skipping question. Deducting", SKIP_COST, "points from total and 5 from stage score.");
                 stopTimer(); // Stop timer

                 totalQuizScore = Math.max(0, totalQuizScore - SKIP_COST); // Deduct points from total score (prevent negative)
                 stageScore = Math.max(0, stageScore - 5); // Deduct 5 points from stage score (prevent negative)
                 correctOrSkippedCount++; // Increment success/skip count for skipped question


                 // Disable buttons during transition
                 disableAnswerAndSkipButtons();

                 updateDashboard(); // Update dashboard to reflect the score change

                  // Optionally show a brief message or highlight, but the request didn't explicitly ask for it.
                  // Maybe just a quick visual flash on the score display?

                 // Proceed to the next question as if it was answered successfully for stage progression
                 console.log("Setting timeout (" + ANSWER_HIGHLIGHT_DELAY + "ms) after skip to display next question...");
                 setTimeout(() => {
                     console.log("--- Timeout callback executing (skipQuestion) ---");
                      // Re-enable buttons is done in displayQuestion when new question is loaded
                     currentQuestionIndexInStage++;
                     displayQuestion(); // Move to next question
                 }, ANSWER_HIGHLIGHT_DELAY); // Use specified delay

             } else {
                 console.warn("Attempted to skip question with insufficient points:", totalQuizScore);
                 // The button should be disabled anyway, but this is a safeguard.
             }
         }

         // Helper to disable answer buttons and skip button
         function disableAnswerAndSkipButtons() {
              Array.from(answerOptionsDiv.children).forEach(button => button.disabled = true);
              skipButton.disabled = true; // Always disable skip button during transition
         }

         // Helper to enable answer buttons and update skip button state
         function enableAnswerAndSkipButtons() {
             Array.from(answerOptionsDiv.children).forEach(button => button.disabled = false);
              // Skip button state depends on total score
              updateSkipButtonState();
         }

         // Helper to update the disabled state of the skip button
         function updateSkipButtonState() {
              skipButton.disabled = totalQuizScore < SKIP_COST;
         }


        // --- Timer Functions ---
        function startTimer() {
            console.log("startTimer called for question index:", currentQuestionIndexInStage);
            timeLeft = TIME_PER_QUESTION;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    stopTimer();
                    handleTimeout();
                }
            }, 1000);
        }

        function stopTimer() {
             console.log("stopTimer called.");
            clearInterval(timerInterval);
        }

        function resetTimer() {
            console.log("resetTimer called.");
            stopTimer();
            timeLeft = TIME_PER_QUESTION;
            updateTimerDisplay();
        }

        
function updateTimerDisplay() {
    const timerText = document.getElementById('timer-text');
    const timerCircle = document.getElementById('timer-circle');
    if (timerText && timerCircle) {
        timerText.textContent = timeLeft;
        const circumference = 100;
        const percentage = timeLeft / TIME_PER_QUESTION;
        const dash = Math.max(0, percentage * circumference);
        timerCircle.setAttribute("stroke-dasharray", dash + ", 100");
        timerCircle.setAttribute("stroke", timeLeft <= 5 ? "#e74c3c" : (timeLeft <= 10 ? "#f39c12" : "#2ecc71"));
    }
}
    
            } else if (timeLeft <= 0) {
                 timerBar.classList.add('critical');
            } else {
                 timerBar.style.backgroundColor = ''; /* Reset to default if not warning/critical */
            }
        }


        function handleTimeout() {
            console.log("--- handleTimeout called for question index:", currentQuestionIndexInStage, "---");
             stopTimer(); // Ensure timer is stopped immediately on timeout event firing

            // Disable all buttons including skip button
            disableAnswerAndSkipButtons();

            // --- No text feedback here, just highlight ---
            const question = selectedQuestionsForStage[currentQuestionIndexInStage];
            // Highlight the correct answer button visually on timeout
             Array.from(answerOptionsDiv.children).forEach(button => {
                if (button.dataset.correct === 'true') {
                     button.style.backgroundColor = '#2ecc71';
                } else {
                     button.style.backgroundColor = '#e74c3c'; // Mark others red
                }
            });
            // Score does NOT increase on timeout (already handled by not adding POINTS_PER_QUESTION)
             // correctOrSkippedCount is NOT incremented for timeouts (they count as incorrect for passing)

             updateDashboard(); // Update dashboard (score doesn't change, but question # will)
            // TODO: Play timeout sound

            console.log("Setting timeout (" + ANSWER_HIGHLIGHT_DELAY + "ms) after timeout to display next question...");
            setTimeout(() => {
                 console.log("--- Timeout callback executing (handleTimeout) ---");
                 // Reset button styles before clearing content for safety
                 Array.from(answerOptionsDiv.children).forEach(button => {
                     button.style.backgroundColor = '';
                 });
                 // Re-enable buttons is done in displayQuestion when new question is loaded
                currentQuestionIndexInStage++;
                displayQuestion(); // Move to next question
                 // feedbackDiv remains hidden
            }, ANSWER_HIGHLIGHT_DELAY); // Use specified delay
        }

        // Update dashboard display
        function updateDashboard() {
             /* console.log("updateDashboard called. Stage:", currentStageIndex + 1, "Q Index:", currentQuestionIndexInStage + 1, "Stage Score:", stageScore, "Total Score:", totalQuizScore); // Commented out to reduce log spam */
             currentStageSpan.textContent = currentStageIndex + 1;
             currentStageThemeSpan.textContent = quizData[currentStageIndex].theme;
             currentQuestionNumSpan.textContent = currentQuestionIndexInStage + 1; // Current question number (1-based)
             totalStageQuestionsSpan.textContent = QUESTIONS_PER_STAGE; // Total questions for the stage (10)
             stageScoreSpan.textContent = stageScore; // Display current stage score
             totalQuizScoreSpan.textContent = totalQuizScore; // Display total accumulated score
        }


        // End the current stage
        function endStage() {
            console.log("--- endStage called for stage index:", currentStageIndex, "---");
            stopTimer(); // Ensure timer is stopped
             skipButton.classList.add('hidden'); // Hide the skip button at the end of the stage
            // quizArea and dashboard are hidden later

            const currentStagePoints = pointsPerStage[currentStageIndex];
            const maxPossibleStageScore = QUESTIONS_PER_STAGE * currentStagePoints;
            // Passing score is now based on the count of correct answers OR skips
            const requiredSuccessesToPass = 9; // Needs 9 correct/skipped questions to pass


            console.log("Final Stage Score (this attempt):", stageScore, "Success/Skipped Count:", correctOrSkippedCount, "Required for Passing:", requiredSuccessesToPass, "Max Possible Stage Score:", maxPossibleStageScore);


            // Update max score display in summary screen
            maxStageScoreSpan.textContent = maxPossibleStageScore;


            // Check if passed based on correctOrSkippedCount
            if (correctOrSkippedCount >= requiredSuccessesToPass) {
                 console.log("Stage passed based on success count.");
                 // totalQuizScore was already updated during the stage for correct answers and skips.

                // Check if there is a NEXT stage AND points data for the next stage
                 if (currentStageIndex + 1 < quizData.length && currentStageIndex + 1 < pointsPerStage.length) {
                     // There is a next stage, show the advanced stage screen
                     console.log("Next stage found. Showing advanced stage screen for stage:", currentStageIndex + 2);
                     // currentStageIndex is incremented ONLY when clicking the 'Start Next Stage' button
                     showAdvancedStageScreen();

                 } else {
                     // Passed the last stage (or no points data for next stage, meaning it's the effective end)
                     console.log("Passed the last available stage based on success count. Showing final completion summary.");
                     endQuiz(true); // Indicate quiz finished successfully (calls showFinalSummary internally)
                 }
            } else {
                 // Did not pass the stage based on success count
                 console.log("Stage not passed based on success count. Showing summary.");
                 // totalQuizScore was updated during the stage.
                 endQuiz(false); // Indicate stage failed (calls showFinalSummary internally)
            }
             console.log("endStage finished. Total Score:", totalQuizScore);
        }

         // Function to retry the current stage
        function retryCurrentStage() {
             console.log("--- retryCurrentStage called ---");
             // currentStageIndex is already set to the stage that was just failed
             // stageScore will be reset to 0 at the start of startStage()
             // correctOrSkippedCount will be reset to 0 at the start of startStage()
             // totalQuizScore remains unchanged from before this failed attempt
             startStage(); // Start the current stage again
        }


        // Show final summary (win or lose for the stage, or final quiz completion)
        // This is used when the quiz flow ENDS for a stage (fail) or for the whole quiz (pass last stage)
        function showFinalSummary(passed) {
             console.log("--- showFinalSummary called, passed:", passed, "---");
            stopTimer(); // Ensure timer is stopped
             skipButton.classList.add('hidden'); // Ensure skip button is hidden


             hideAllScreens(); // Hide all quiz screens

             stageSummary.classList.remove('hidden'); // Show summary screen

             // Display stage score for the attempt that just finished
            stageSummaryScoreText.classList.remove('hidden'); // Make sure stage score is visible
            finalStageScoreSpan.textContent = stageScore;

             // Update max stage score in summary (redundant if called from endStage but safe)
             const currentStagePoints = pointsPerStage[currentStageIndex] || 5; // Default to 5 if points data missing
             const maxPossibleStageScore = QUESTIONS_PER_STAGE * currentStagePoints;
             maxStageScoreSpan.textContent = maxPossibleStageScore;


            // Always show total score in summary
            totalScoreSummaryText.classList.remove('hidden');
            totalScoreSummarySpan.textContent = totalQuizScore;


            // Remove existing button from summary
            if (summaryButton) {
                 summaryButton.remove();
                 summaryButton = null; // Clear reference
            }

            if (passed) {
                 // This case is ONLY for passing the *last* stage
                 stageResultPara.textContent = 'כל הכבוד! סיימת את כל השלבים בחידון בהצלחה!'; // Final completion message
                 stageResultPara.classList.remove('incorrect');
                 stageResultPara.classList.add('correct');
                 addSummaryButton("שחק שוב", false); // false means it's not a retry button for current stage
            } else {
                // Failed the stage
                const requiredSuccessesToPass = 9; // Needs 9 correct/skipped questions to pass
                // Updated failure message to reflect the 9 successes rule
                stageResultPara.textContent = `לא עברת את שלב ${currentStageIndex + 1}. נסה שוב! (צריך ${requiredSuccessesToPass} תשובות נכונות או דילוגים לשלב)`;
                stageResultPara.classList.remove('correct');
                stageResultPara.classList.add('incorrect');
                 addSummaryButton("נסה שוב", true); // This is a retry button for the current stage
            }


             console.log("Quiz finished (or stage failed). Total Score:", totalQuizScore);
        }


        // Helper to add button to the summary screen
        // The 'isRetry' flag determines which function the button calls
        function addSummaryButton(buttonText = "נסה שוב", isRetry = true) {
            console.log("addSummaryButton called with text:", buttonText, "isRetry:", isRetry);
            // Ensure no previous button exists before adding
            if (!summaryButton) { // Check if the reference is null
                summaryButton = document.createElement('button');
                summaryButton.textContent = buttonText;
                summaryButton.id = 'summary-button'; // Add ID
                // Styling is handled by the .summary-button CSS rule

                if (isRetry) {
                     // If it's a retry button (stage failed)
                    summaryButton.addEventListener('click', retryCurrentStage);
                } else {
                     // If it's a play again button (quiz finished)
                    summaryButton.addEventListener('click', restartQuiz); // Reloads the page
                }

                stageSummary.appendChild(summaryButton);
            }
        }

        // Basic restart function (reloads the page for simplicity)
        // This is ONLY called after successfully completing the FINAL stage.
        function restartQuiz() {
            console.log("Restarting entire quiz...");
            window.location.reload();
        }

        // Implement endQuiz for when there are no more stages (called if startStage fails due to no next stage)
        // This function is called if startStage fails because no data is found for the next stage.
        // It's also called from showStageIntro if the requested stage index is out of bounds.
        // Added a boolean to indicate if the quiz was completed vs. an error occurred.
        function endQuiz(completedSuccessfully = false) {
             console.log("--- endQuiz called, completedSuccessfully:", completedSuccessfully, "---");
             stopTimer(); // Ensure timer is stopped
              skipButton.classList.add('hidden'); // Ensure skip button is hidden


             hideAllScreens(); // Hide all quiz screens

             stageSummary.classList.remove('hidden'); // Show summary screen

             // In case of completion, hide the "Score for this stage" line, only show total
             if (completedSuccessfully) {
                  stageSummaryScoreText.classList.add('hidden'); // Hide stage score line on full completion
                  totalScoreSummaryText.classList.remove('hidden'); // Ensure total score is shown
                  totalScoreSummarySpan.textContent = totalQuizScore;

                 stageResultPara.textContent = 'כל הכבוד! סיימת את כל השלבים בחידון בהצלחה!'; // Final completion message
                 stageResultPara.classList.remove('incorrect');
                 stageResultPara.classList.add('correct');
                 addSummaryButton("שחק שוב", false); // Not a retry button

             } else {
                 // This case is primarily for stage failure
                 stageSummaryScoreText.classList.remove('hidden'); // Show stage score line
                 finalStageScoreSpan.textContent = stageScore; // Show stage score

                  // Update max stage score in summary for the failed stage
                 const currentStagePoints = pointsPerStage[currentStageIndex] || 5; // Default to 5 if points data missing
                 const maxPossibleStageScore = QUESTIONS_PER_STAGE * currentStagePoints;
                 maxStageScoreSpan.textContent = maxPossibleStageScore;


                  totalScoreSummaryText.classList.remove('hidden'); // Still show total score accumulated BEFORE this failed attempt
                  totalScoreSummarySpan.textContent = totalQuizScore;


                 const requiredSuccessesToPass = 9; // Needs 9 correct/skipped questions to pass
                 // Updated failure message to reflect the 9 successes rule
                 stageResultPara.textContent = `לא עברת את שלב ${currentStageIndex + 1}. נסה שוב! (צריך ${requiredSuccessesToPass} תשובות נכונות או דילוגים לשלב)`;
                 stageResultPara.classList.remove('correct');
                 stageResultPara.classList.add('incorrect');
                 addSummaryButton("נסה שוב", true); // This is a retry button for the current stage
             }


             console.log("Quiz finished (or stage failed). Total Score:", totalQuizScore);
        }


        // --- Sound Functionality (Requires Sound Files) ---
        // ... (sound code remains commented out) ...


        // --- Start the process ---
        // Use initQuiz to start the quiz flow which shows the initial intro
        window.addEventListener('load', initQuiz);

    </script>

<script>
// This script block remains for celebration messages and confetti
document.addEventListener("DOMContentLoaded", function () {
    function triggerConfetti(level) {
        const basePower = 100 + level * 30;
        confetti({
            particleCount: basePower,
            spread: 90 + level * 5,
            origin: { y: 0.6 }
        });
    }

    const stageMessages = [
        "כל הכבוד! עברת את שלב א!", // Message for completing stage 1
        "מעולה! עברת את שלב ב'!", // Message for completing stage 2
        "אדיר! עברת את שלב ג'!", // Message for completing stage 3
        "נהדר! עברת את שלב ד'!", // Message for completing stage 4
        "וואו! עברת את שלב ה'!", // Message for completing stage 5
        "מדהים! סיימת את החידון!" // Message for completing stage 6 (the last stage)
    ];

    window.showCelebrationMessage = function(message) {
        const msgDiv = document.getElementById('celebration-message');
        msgDiv.textContent = message;
        msgDiv.classList.remove('hidden', 'fade-out');
        msgDiv.classList.add('fade-in');
        setTimeout(() => {
            msgDiv.classList.remove('fade-in');
            msgDiv.classList.add('fade-out');
        }, 4000);
    };

    // This function is called from endStage when a stage is passed and there's a next stage
    window.showAdvancedStageScreen = function() {
         console.log("showAdvancedStageScreen (Celebration Script) called. Stage completed:", currentStageIndex);
        hideAllScreens(); // Hide everything first

        const nextStageIndex = currentStageIndex + 1; // Index of the stage AFTER the one just completed

        // Set background for the *next* stage using the main setBackgroundForCurrentStage (from the main script block)
        // Temporarily update currentStageIndex to use the main function correctly
         const originalStageIndex = currentStageIndex;
         currentStageIndex = nextStageIndex; // Set to the index of the *next* stage
         setBackgroundForCurrentStage(); // Use the main function
         currentStageIndex = originalStageIndex; // Restore original index


        advancedStageScreen.classList.remove('hidden'); // Show the advanced stage screen

        // Update text to reflect the completed and next stage numbers
        completedStageNumAdvSpan.textContent = currentStageIndex + 1; // The stage that was just completed (1-based)
        // Check bounds for next stage data
        const nextStageTheme = (nextStageIndex < quizData.length && quizData[nextStageIndex].theme) ? quizData[nextStageIndex].theme : 'השלב הבא';
        nextStageNumAdvSpan.textContent = nextStageIndex + 1; // Next stage number (1-based)
        nextStageThemeAdvSpan.textContent = nextStageTheme;

        // Select message based on the stage *just completed* (currentStageIndex before incrementing for next stage)
        const msg = stageMessages[currentStageIndex] || "שלב נוסף הושלם!"; // Use index of completed stage
        showCelebrationMessage(msg);

        triggerConfetti(currentStageIndex + 1); // Trigger confetti based on completed stage number (1-based)


         console.log("Advanced stage screen showing, next stage:", nextStageIndex + 1);
    };
});
</script>


<script>

function loadStageFromFile(stageId, filePath, theme) {
  return fetch(filePath)
    .then(response => response.json())
    .then(data => {
      // Add validation here: Ensure data is an array and each item has required properties
      const questions = data.filter(q => {
          // Filter out items that are not objects, or are missing required properties
          return typeof q === 'object' && q !== null &&
                 typeof q.question === 'string' &&
                 Array.isArray(q.options) && // Explicitly check if options is an array
                 q.options.every(opt => typeof opt === 'string') && // Optional: check if all options are strings
                 typeof q.correct === 'number' &&
                 q.correct >= 0 && q.correct < q.options.length; // Check if correct index is valid
      }).map((q, index) => ({
        id: index + 1, // You could potentially use q.id if your JSON has it, but index+1 is safer
        text: q.question,
        options: q.options,
        correctAnswerIndex: q.correct
      }));

      // Add a check to ensure we got enough valid questions
      if (questions.length < QUESTIONS_PER_STAGE) {
          console.warn(`אזהרה: קובץ ${filePath} מכיל רק ${questions.length} שאלות תקינות. נדרשות לפחות ${QUESTIONS_PER_STAGE} שאלות לשלב.`);
           // Decide how to handle this - currently, it will proceed with fewer questions if available >= 10
           // If you want to strictly require 10, you might throw an error here
           // throw new Error(`Not enough valid questions in ${filePath}`);
      }


      quizData.push({
        stageId: stageId,
        theme: theme,
        // Corrected background image file extension and path
        background_image: `https://hidon1.github.io/background-stage-${stageId}.jpg`,
        questions: questions
      });
    })
    .catch(err => {
      console.error("שגיאה בטעינת קובץ השאלות או עיבוד הנתונים:", filePath, err); // Updated error message
      alert("שגיאה בטעינת השאלות מהקובץ " + filePath + ". אנא ודא שהמבנה נכון."); // Updated alert message
      // Crucially, if a file fails to load, the Promise.all will reject
      throw err; // Re-throw the error so the .catch on Promise.all is triggered
    });
}

// Load all 6 stages

Promise.all([
  // Corrected file paths to remove the extra /hidon1/ subdirectory
  loadStageFromFile(1, "https://hidon1.github.io/hidon1/1.json", "שלב א: שאלות ראשונות"),
  loadStageFromFile(2, "https://hidon1.github.io/hidon1/2.json", "שלב ב: שאלות מתקדמות"),
  loadStageFromFile(3, "https://hidon1.github.io/hidon1/3.json", "שלב ג: דמויות ומלכים"),
  loadStageFromFile(4, "https://hidon1.github.io/hidon1/4.json", "שלב ד: מאורעות וזמנים"),
  loadStageFromFile(5, "https://hidon1.github.io/hidon1/5.json", "שלב ה: המשך"),
  loadStageFromFile(6, "https://hidon1.github.io/hidon1/6.json", "שלב ו: סיום")
]).then(() => {
  console.log("כל ששת השלבים נטענו בהצלחה");
  console.log("Quiz data loaded:", quizData); // Log loaded data for debugging
   initQuiz(); // Initialize quiz after data is loaded
}).catch(err => {
    console.error("שגיאה קריטית: כשל בטעינת קבצי שלבים:", err); // Updated error message
    // Display a message to the user if loading fails
    const initialIntroElement = document.getElementById('initial-intro');
    if (initialIntroElement) {
        initialIntroElement.innerHTML = `
           <h1>חידון התנ"ך</h1>
           <p style="color: red;">שגיאה קריטית: לא ניתן היה לטעון את קבצי השאלות הדרושים. אנא ודא שהקבצים קיימים במיקום הנכון ב-GitHub Pages, ושהמבנה שלהם תקין לחלוטין.</p>
        `;
        hideAllScreens();
        initialIntroElement.classList.remove('hidden');
         // Ensure initial start button is hidden as quiz cannot proceed
         const initialStartButton = document.getElementById('initial-start-button');
         if(initialStartButton) {
             initialStartButton.classList.add('hidden');
         }
    }
});

    </script>

</body>
</html>